<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Number Guess Game</title>
    <style>
        body { font-family: Arial, sans-serif; padding:1rem; max-width:700px; margin:auto; background:#fdf6e3;}
        h2,h3{ text-align:center;}
        .torn-paper { background:#fffdf6; padding:1rem; margin:1.5rem 0; border:1px solid #ccc; border-radius:5px; box-shadow:0 4px 8px rgba(0,0,0,0.15); position:relative; overflow:hidden;}
        .torn-paper:before, .torn-paper:after { content:""; position:absolute; width:100%; height:20px; left:0; background:#fffdf6; z-index:1;}
        .torn-paper:before { top:-10px; clip-path:polygon(0% 100%,10% 0%,20% 100%,30% 0%,40% 100%,50% 0%,60% 100%,70% 0%,80% 100%,90% 0%,100% 100%);}
        .torn-paper:after { bottom:-10px; clip-path:polygon(0% 0%,10% 100%,20% 0%,30% 100%,40% 0%,50% 100%,60% 0%,70% 100%,80% 0%,90% 100%,100% 0%);}
        .keypad { display:flex; flex-wrap:wrap; justify-content:center; margin:1rem 0;}
        .keypad button{ width:60px;height:60px;margin:5px;font-size:1.5rem;background:#3498db;color:white;border:none;border-radius:10px;}
        .guess-display{ font-size:2rem; text-align:center; margin:1rem 0; min-height:2.5rem;}
        ul{list-style:none;padding:0;} li{margin:0.3rem 0;background:#eee;padding:0.4rem;border-radius:5px;}
        .clear-btn{background:#e74c3c;}
    </style>
</head>
<body>

<h2>🎯 Number Guess Game</h2>

<script>
const userId = "{{ user_id }}";
const username = "{{ username }}";

let currentGuess="", singleGameId=null, roomId=null, roomCode=null, poller=null, chatPoller=null;
</script>

<div class="torn-paper" id="setupArea">
    <h3>Start New Game</h3>
    <label>Digits: <input type="number" id="numDigits" min="3" max="8" value="4"></label><br><br>
    <button onclick="startSinglePlayer()">Single Player</button>
    <button onclick="showCreate()">Create Multiplayer Room</button>
    <button onclick="showJoin()">Join Room</button>
</div>

<div class="torn-paper" id="createDiv" style="display:none;">
    <h3>Create Room</h3>
    <label>Mode: <select id="mode" onchange="toggleSecret()"><option value="bot">Vs Bot</option><option value="2player">2 Player</option></select></label><br><br>
    <label>Winning: <select id="winningType"><option value="fastest">Fastest</option><option value="lowest">Least Turns</option></select></label><br><br>
    <div id="secretDiv" style="display:none;"><label>Secret: <input type="text" id="secretNumber"></label><br><br></div>
    <button onclick="createRoom()">Create Room</button>
    <button onclick="goBack()">🔙 Back</button>
</div>

<div class="torn-paper" id="joinDiv" style="display:none;">
    <h3>Join Room</h3>
    <label>Code: <input type="text" id="roomCode"></label><br><br>
    <button onclick="joinRoom()">Join</button>
    <button onclick="goBack()">🔙 Back</button>
</div>

<div class="torn-paper" id="singlePlayerArea" style="display:none;">
    <h3>Single Player</h3>
    <div class="guess-display" id="guessDisplaySP"></div>
    <div class="keypad" id="spKeypad"></div>
    <ul id="historySP"></ul>
    <button onclick="goBack()">🔙 Back</button>
</div>

<div class="torn-paper" id="gameArea" style="display:none;">
    <h3>Room: <span id="showRoomCode"></span></h3>
    <div class="guess-display" id="guessDisplay"></div>
    <div class="keypad" id="mpKeypad"></div>
    <ul id="history"></ul>
    <button onclick="goBack()">🔙 Back</button>
</div>

<div class="torn-paper" id="chatArea" style="display:none;">
    <h3>💬 Chat</h3>
    <ul id="chatBox" style="height:150px;overflow-y:auto;"></ul>
    <input type="text" id="chatMsg" placeholder="Type message..." style="width:80%;">
    <button onclick="sendMessage()">Send</button>
</div>

<div class="torn-paper" id="summaryArea" style="display:none;">
    <h3>🏆 Game Summary</h3>
    <ul id="summaryList"></ul>
</div>

<script>
function showCreate(){document.getElementById("setupArea").style.display="none";document.getElementById("createDiv").style.display="block";}
function showJoin(){document.getElementById("setupArea").style.display="none";document.getElementById("joinDiv").style.display="block";}
function goBack(){location.reload();}
function toggleSecret(){document.getElementById("secretDiv").style.display=(document.getElementById("mode").value==="2player")?"block":"none";}

async function startSinglePlayer(){
    const digits = parseInt(document.getElementById("numDigits").value) || 4;
    const form = new FormData();
    form.append("num_digits", digits);
    const res = await fetch("/start_game", {method:"POST", body:form});
    const data = await res.json();
    singleGameId = data.game_id;
    document.getElementById("setupArea").style.display="none";
    document.getElementById("singlePlayerArea").style.display="block";
    setupButtons("spKeypad", makeSingleGuess);
}

function setupButtons(containerId, callback){
    const container=document.getElementById(containerId);
    container.innerHTML="";
    const digits=[1,2,3,4,5,6,7,8,9,0];
    digits.forEach(d=>{
        let btn=document.createElement("button");
        btn.textContent=d;
        btn.onclick=()=>{currentGuess+=d;updateDisplay(containerId);};
        container.appendChild(btn);
    });
    let clearBtn=document.createElement("button");
    clearBtn.textContent="Clear";clearBtn.className="clear-btn";
    clearBtn.onclick=()=>{currentGuess="";updateDisplay(containerId);};
    container.appendChild(clearBtn);

    let guessBtn=document.createElement("button");
    guessBtn.textContent="Guess";
    guessBtn.onclick=()=>{callback();};
    container.appendChild(guessBtn);
}

function updateDisplay(containerId){
    if(containerId==="spKeypad")document.getElementById("guessDisplaySP").textContent=currentGuess;
    else document.getElementById("guessDisplay").textContent=currentGuess;
}

async function makeSingleGuess(){
    const form=new FormData();
    form.append("game_id", singleGameId);
    form.append("guess", currentGuess);
    const res=await fetch("/guess", {method:"POST",body:form});
    const data=await res.json();
    const li=document.createElement("li");
    li.innerText=`Guess: ${currentGuess} → In: ${data.numbers_correct}, Place: ${data.positions_correct}`;
    document.getElementById("historySP").appendChild(li);
    if(data.completed)alert(`🎉 You guessed in ${data.turns} turns!`);
    currentGuess="";
    updateDisplay("spKeypad");
}

async function createRoom(){
    const form=new FormData();
    form.append("user_id", userId);
    form.append("username", username);
    form.append("mode", document.getElementById("mode").value);
    form.append("num_digits", document.getElementById("numDigits").value);
    form.append("winning_type", document.getElementById("winningType").value);
    if(document.getElementById("mode").value==="2player")
        form.append("secret_number", document.getElementById("secretNumber").value);
    const res=await fetch("/create_room",{method:"POST",body:form});
    const data=await res.json();
    roomId=data.room_id;roomCode=data.room_code;
    document.getElementById("showRoomCode").textContent=roomCode;
    startMultiplayer();
}

async function joinRoom(){
    const form = new FormData();
    form.append("room_code", document.getElementById("roomCode").value);
    form.append("user_id", userId);
    form.append("username", username);
    const res = await fetch("/join_room",{method:"POST",body:form});
    const data = await res.json();
    roomId=data.room.id;roomCode=data.room.room_code;
    document.getElementById("showRoomCode").textContent=roomCode;
    startMultiplayer();
}

function startMultiplayer(){
    document.getElementById("createDiv").style.display="none";
    document.getElementById("joinDiv").style.display="none";
    document.getElementById("setupArea").style.display="none";
    document.getElementById("gameArea").style.display="block";
    document.getElementById("chatArea").style.display="block";
    setupButtons("mpKeypad", makeMultiplayerGuess);
    pollRoomStatus();pollChat();
}

async function makeMultiplayerGuess(){
    const form=new FormData();
    form.append("room_id", roomId);
    form.append("user_id", userId);
    form.append("guess", currentGuess);
    const res=await fetch("/room_guess",{method:"POST",body:form});
    const data=await res.json();
    const li=document.createElement("li");
    li.innerText=`Guess: ${currentGuess} → In: ${data.numbers_correct}, Place: ${data.positions_correct}`;
    document.getElementById("history").appendChild(li);
    if(data.completed)alert(`🎉 You guessed in ${data.turns} turns!`);
    if(data.room_completed)pollRoomStatus(true);
    currentGuess=""; updateDisplay("mpKeypad");
}

async function pollRoomStatus(force=false){
    const res=await fetch(`/room_status?room_id=${roomId}`);
    const data=await res.json();
    if(data.status==="completed"&&data.winner){
        alert(`🏆 ${data.winner.username} won in ${data.winner.turns} turns!`);
        showSummary();clearTimeout(poller);
    }else if(!force){poller=setTimeout(pollRoomStatus,2000);}
}

async function showSummary(){
    document.getElementById("summaryArea").style.display="block";
    const res=await fetch(`/get_room_summary?room_id=${roomId}`);
    const players=await res.json();
    let list=document.getElementById("summaryList");list.innerHTML="";
    players.forEach(p=>{let li=document.createElement("li");li.textContent=`${p.username}: ${p.turns} turns`;list.appendChild(li);});
}

async function sendMessage(){
    const msg=document.getElementById("chatMsg").value.trim();
    if(!msg)return;
    const form=new FormData();
    form.append("room_id",roomId);form.append("user_id",userId);form.append("username",username);form.append("message",msg);
    await fetch("/send_message",{method:"POST",body:form});
    document.getElementById("chatMsg").value=""; loadChat();
}
async function pollChat(){ await loadChat(); chatPoller=setTimeout(pollChat,2000);}
async function loadChat(){
    const res=await fetch(`/get_messages?room_id=${roomId}`);
    const msgs=await res.json();
    let box=document.getElementById("chatBox"); box.innerHTML="";
    msgs.forEach(m=>{let li=document.createElement("li");li.textContent=`${m.username}: ${m.message}`;box.appendChild(li);});
    box.scrollTop=box.scrollHeight;
}
</script>

</body>
</html>
